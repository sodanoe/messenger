
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Test - Messenger (Fixed)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            max-width: 100%;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .sidebar {
            width: 250px;
            background-color: #f0f8ff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
        }
        input, button {
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .messages {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
            font-family: monospace;
        }
        .message { margin: 5px 0; }
        .status { font-weight: bold; }
        .user-button {
            display: block;
            margin: 5px 0;
            padding: 5px 10px;
            background-color: #007bff;
            color: white;
            text-align: left;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .user-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>–û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div id="userList"></div>
        <button onclick="getOnlineUsers()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
    <div class="main">
        <div class="container">
            <h2>WebSocket Chat</h2>
            <input id="token" placeholder="JWT Token" style="width: 300px;">
            <button onclick="connect()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <button onclick="disconnect()">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            <br>
            <input id="chatId" placeholder="Chat ID">
            <button onclick="subscribeToChat()">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
            <button onclick="unsubscribeFromChat()">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
            <br>
            <div class="messages" id="messages"></div>
            <input id="messageText" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="width: 70%;">
            <button onclick="sendPing()">Ping</button>
            <button onclick="clearMessages()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
    </div>
    <script>
        let ws = null;
        let pingTime = 0;

        function connect() {
            const token = document.getElementById('token').value.trim();
            if (!token) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω!');
            ws = new WebSocket(`ws://127.0.0.1:8000/ws/chat/${token}`);
            ws.onopen = () => addMessage('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
            ws.onmessage = (event) => handleMessage(JSON.parse(event.data));
            ws.onclose = (e) => addMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ: ' + e.reason);
            ws.onerror = () => addMessage('‚ùå –û—à–∏–±–∫–∞ WebSocket');
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                addMessage('üîå –û—Ç–∫–ª—é—á–µ–Ω–æ');
            }
        }

        function sendPing() {
            if (!ws) return;
            pingTime = Date.now();
            ws.send(JSON.stringify({ type: 'ping' }));
        }

        function subscribeToChat() {
            const chatId = parseInt(document.getElementById('chatId').value);
            if (ws && chatId) {
                ws.send(JSON.stringify({ type: 'subscribe_chat', chat_id: chatId }));
                addMessage(`üü¢ –ü–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ —á–∞—Ç ${chatId}`);
            }
        }

        function unsubscribeFromChat() {
            const chatId = parseInt(document.getElementById('chatId').value);
            if (ws && chatId) {
                ws.send(JSON.stringify({ type: 'unsubscribe_chat', chat_id: chatId }));
                addMessage(`üî¥ –û—Ç–ø–∏—Å–∞–Ω –æ—Ç —á–∞—Ç–∞ ${chatId}`);
            }
        }

        function addMessage(msg) {
            const div = document.createElement('div');
            div.className = 'message';
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            document.getElementById('messages').appendChild(div);
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        function handleMessage(data) {
            if (data.type === 'pong') {
                const latency = Date.now() - pingTime;
                addMessage(`üèì Pong (${latency}ms)`);
            } else if (data.type === 'private_message') {
                addMessage(`üì• –õ–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${data.from_user_id}: ${data.text}`);
            } else {
                addMessage(`üì¶ ${JSON.stringify(data)}`);
            }
        }

        function getOnlineUsers() {
            fetch('http://127.0.0.1:8000/ws/online-users')
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('userList');
                    container.innerHTML = '';
                    data.online_users.forEach(user => {
                        const btn = document.createElement('button');
                        btn.className = 'user-button';
                        btn.textContent = `üë§ ${user.username} (id: ${user.id})`;
                        btn.onclick = () => sendPrivateMessage(user.id);
                        container.appendChild(btn);
                    });
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ fetch:', error);
                    addMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω: ${error.message}`);
                });
        }


        function sendPrivateMessage(userId) {
            const text = prompt(`–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}:`);
            if (text && ws) {
                ws.send(JSON.stringify({
                    type: 'private_message',
                    to_user_id: userId,
                    text: text
                }));
                addMessage(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${userId}: ${text}`);
            }
        }
    </script>
</body>
</html>
